<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>üí™ Patrick Workout</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #e94560;
            --secondary: #0f3460;
            --bg: #1a1a2e;
            --card: #16213e;
            --text: #eaeaea;
            --success: #4ecca3;
            --warning: #ffc107;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: var(--card);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-btns {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.1s, opacity 0.2s;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn.secondary {
            background: var(--secondary);
        }
        
        .btn.success {
            background: var(--success);
            color: #1a1a2e;
        }
        
        /* Views */
        .view {
            display: none;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .view.active {
            display: block;
        }
        
        /* Exercise List */
        .exercise-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .exercise-card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .exercise-card:active {
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.3);
        }
        
        .exercise-card .drag-handle {
            color: #666;
            font-size: 1.2rem;
        }
        
        .exercise-card .info {
            flex: 1;
        }
        
        .exercise-card .name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        
        .exercise-card .meta {
            font-size: 0.85rem;
            color: #aaa;
            display: flex;
            gap: 12px;
        }
        
        .exercise-card .actions {
            display: flex;
            gap: 8px;
        }
        
        .exercise-card .actions button {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }
        
        .exercise-card .actions button:hover {
            color: var(--primary);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-row {
            display: flex;
            gap: 12px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .modal-btns {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .modal-btns .btn {
            flex: 1;
            justify-content: center;
        }
        
        /* Workout View */
        #workoutView {
            padding: 0;
            height: 100vh;
            display: none;
            flex-direction: column;
        }
        
        #workoutView.active {
            display: flex;
        }
        
        .workout-header {
            background: var(--card);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .workout-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            width: 100px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar .fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }
        
        .workout-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }
        
        .exercise-name {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .exercise-description {
            font-size: 1.1rem;
            color: #ccc;
            margin-bottom: 40px;
            line-height: 1.6;
            max-width: 400px;
        }
        
        .timer-display {
            font-size: 6rem;
            font-weight: 200;
            font-variant-numeric: tabular-nums;
            margin-bottom: 20px;
        }
        
        .reps-display {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .reps-display span {
            font-size: 1.5rem;
            color: #888;
        }
        
        .workout-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        
        .workout-controls .btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 1.8rem;
            justify-content: center;
        }
        
        .workout-controls .btn.large {
            width: 90px;
            height: 90px;
            font-size: 2.2rem;
        }
        
        /* Rest Screen */
        .rest-screen {
            background: var(--secondary);
        }
        
        .rest-screen .exercise-name {
            color: var(--success);
        }
        
        .next-up {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .next-up .label {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 8px;
        }
        
        .next-up .name {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        /* Complete Screen */
        .complete-screen {
            text-align: center;
            padding: 40px;
        }
        
        .complete-screen .icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        
        .complete-screen h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--success);
        }
        
        .complete-screen .stats {
            margin: 30px 0;
            padding: 20px;
            background: var(--card);
            border-radius: 12px;
        }
        
        .complete-screen .stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        
        .complete-screen .stat:last-child {
            border-bottom: none;
        }
        
        /* FAB */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
            z-index: 50;
        }
        
        /* Import/Export */
        .import-section {
            margin-top: 30px;
            padding: 20px;
            background: var(--card);
            border-radius: 12px;
        }
        
        .import-section h3 {
            margin-bottom: 15px;
            font-size: 1rem;
        }
        
        .import-section .code-input {
            display: flex;
            gap: 10px;
        }
        
        .import-section input {
            flex: 1;
        }
        
        /* Workout Select */
        .workout-select {
            margin-bottom: 20px;
        }
        
        .workout-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .workout-tab {
            background: var(--card);
            border: 2px solid transparent;
            color: var(--text);
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .workout-tab.active {
            border-color: var(--primary);
            background: rgba(233, 69, 96, 0.2);
        }
        
        .workout-tab .delete {
            margin-left: 8px;
            opacity: 0.5;
        }
        
        .workout-tab .delete:hover {
            opacity: 1;
        }

        /* Start Workout Button */
        .start-workout-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(transparent, var(--bg) 30%);
            z-index: 50;
        }
        
        .start-workout-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        /* Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Exercise Animation with Real Images */
        .exercise-animation {
            width: 280px;
            height: 200px;
            margin: 0 auto 20px auto;
            border-radius: 12px;
            overflow: hidden;
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .exercise-animation img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .exercise-animation .emoji-fallback {
            font-size: 5rem;
        }
        
        .exercise-animation.loading::after {
            content: '‚è≥';
            font-size: 3rem;
            position: absolute;
        }
        
        /* Radio Toggle Button */
        .radio-toggle-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.1s, background 0.2s;
            margin-top: 10px;
        }
        .radio-toggle-btn:active { transform: scale(0.95); }
        .radio-toggle-btn.radio-on { background: rgba(6,214,160,0.2); border-color: #06d6a0; }

        /* Radio Player */
        .radio-player {
            display: none;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 15px;
            margin-top: 15px;
            width: 100%;
            max-width: 400px;
        }
        .radio-player.visible { display: block; }
        .radio-player-label { font-size: 0.85em; opacity: 0.5; margin-bottom: 10px; text-align: center; }
        .genre-tabs { display: flex; gap: 8px; margin-bottom: 12px; justify-content: center; flex-wrap: wrap; }
        .genre-tab {
            padding: 8px 14px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05); color: white;
            cursor: pointer; font-size: 0.8em; transition: all 0.2s;
        }
        .genre-tab.active { background: #06d6a0; border-color: #06d6a0; color: #000; font-weight: 600; }
        .station-list { max-height: 200px; overflow-y: auto; margin-bottom: 12px; scrollbar-width: thin; }
        .station-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; border-radius: 12px; cursor: pointer; transition: all 0.2s;
        }
        .station-item:hover { background: rgba(255,255,255,0.08); }
        .station-item.playing { background: rgba(6,214,160,0.15); border-left: 3px solid #06d6a0; }
        .station-logo {
            width: 40px; height: 40px; border-radius: 8px;
            background: rgba(255,255,255,0.1); display: flex;
            align-items: center; justify-content: center; font-size: 1.2em; overflow: hidden;
        }
        .station-logo img { width: 100%; height: 100%; object-fit: cover; }
        .station-name { font-size: 0.9em; font-weight: 600; }
        .station-tags { font-size: 0.7em; opacity: 0.5; }
        .now-playing {
            display: none; align-items: center; gap: 12px;
            padding: 12px; background: rgba(6,214,160,0.1);
            border-radius: 12px; margin-bottom: 12px;
        }
        .now-playing.active { display: flex; }
        .np-info { flex: 1; }
        .np-name { font-size: 0.9em; font-weight: 700; }
        .np-genre { font-size: 0.75em; opacity: 0.5; }
        .np-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.15); color: white;
            font-size: 1.1em; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
        }
        .eq-bars { display: flex; gap: 2px; height: 20px; align-items: flex-end; }
        .eq-bar { width: 3px; background: #06d6a0; border-radius: 2px; animation: equalize 0.8s ease infinite alternate; }
        .eq-bar:nth-child(1) { animation-duration: 0.6s; height: 8px; }
        .eq-bar:nth-child(2) { animation-duration: 0.9s; height: 14px; }
        .eq-bar:nth-child(3) { animation-duration: 0.7s; height: 10px; }
        .eq-bar:nth-child(4) { animation-duration: 1.1s; height: 16px; }
        @keyframes equalize { from { height: 4px; } to { height: 20px; } }
        .volume-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
        .volume-row span { font-size: 0.8em; opacity: 0.5; }
        .volume-slider {
            flex: 1; -webkit-appearance: none; height: 4px;
            border-radius: 2px; background: rgba(255,255,255,0.2); outline: none;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            border-radius: 50%; background: #06d6a0; cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Main List View -->
    <div id="listView" class="view active">
        <div class="header">
            <h1>üí™ Patrick Workout</h1>
            <div class="header-btns">
                <button class="btn secondary" onclick="showImportModal()">üì•</button>
                <button class="btn secondary" onclick="showExportModal()">üì§</button>
            </div>
        </div>
        
        <div style="padding: 20px;">
            <div class="workout-select">
                <div class="workout-tabs" id="workoutTabs"></div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn secondary" style="flex: 1;" onclick="showNewWorkoutModal()">
                        ‚ûï Nuovo
                    </button>
                    <button class="btn" style="flex: 1; background: #c0392b;" onclick="deleteCurrentWorkout()">
                        üóë Elimina
                    </button>
                </div>
            </div>
            
            <div class="exercise-list" id="exerciseList"></div>
            
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="icon">üèãÔ∏è</div>
                <h3>Nessun esercizio</h3>
                <p style="margin-top: 10px;">Aggiungi il tuo primo esercizio!</p>
            </div>
        </div>
        
        <button class="fab" onclick="showAddExerciseModal()">+</button>
        
        <div class="start-workout-bar" id="startBar" style="display: none;">
            <button class="btn success start-workout-btn" onclick="startWorkout()">
                ‚ñ∂Ô∏è Inizia Allenamento
            </button>
        </div>
    </div>
    
    <!-- Workout View -->
    <div id="workoutView" class="view">
        <div class="workout-header">
            <button class="btn secondary" onclick="exitWorkout()">‚úï Esci</button>
            <div class="workout-progress">
                <span id="progressText">1/5</span>
                <div class="progress-bar">
                    <div class="fill" id="progressFill" style="width: 20%"></div>
                </div>
            </div>
        </div>
        
        <div class="workout-main" id="workoutMain">
            <div class="exercise-animation" id="exerciseAnimation">üèãÔ∏è</div>
            <div class="exercise-name" id="currentExerciseName">Squat</div>
            <div class="exercise-description" id="currentExerciseDesc">
                Piedi larghezza spalle, scendi fino a cosce parallele al suolo.
            </div>
            <button class="radio-toggle-btn" id="radioToggleBtn" onclick="toggleRadioPanel()">üìª Radio</button>
            <div class="radio-player" id="radioPlayer">
                <div class="radio-player-label">üìª MJ Radio Workout</div>
                <div class="genre-tabs" id="genreTabs">
                    <button class="genre-tab active" onclick="loadGenre('energy', this)">üî• Energy</button>
                    <button class="genre-tab" onclick="loadGenre('chill', this)">üßò Chill</button>
                    <button class="genre-tab" onclick="loadGenre('hiphop', this)">üé§ Hip-Hop</button>
                    <button class="genre-tab" onclick="loadGenre('dance', this)">üíÉ Dance</button>
                </div>
                <div class="now-playing" id="nowPlaying">
                    <div class="eq-bars"><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div></div>
                    <div class="np-info">
                        <div class="np-name" id="npName">‚Äî</div>
                        <div class="np-genre" id="npGenre">‚Äî</div>
                    </div>
                    <div><button class="np-btn" onclick="stopRadio()">‚èπ</button></div>
                </div>
                <div class="volume-row">
                    <span>üîà</span>
                    <input type="range" class="volume-slider" id="radioVolume" min="0" max="100" value="80" oninput="setRadioVolume(this.value)">
                    <span>üîä</span>
                </div>
                <div class="station-list" id="stationList">
                    <div style="text-align:center;opacity:0.5;padding:20px;">Caricamento stazioni...</div>
                </div>
            </div>
            <div class="timer-display" id="timerDisplay">0:30</div>
            <div class="workout-controls">
                <button class="btn secondary" onclick="prevExercise()">‚èÆ</button>
                <button class="btn large" id="playPauseBtn" onclick="togglePause()">‚è∏</button>
                <button class="btn secondary" onclick="nextExercise()">‚è≠</button>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Exercise Modal -->
    <div class="modal-overlay" id="exerciseModal">
        <div class="modal">
            <h2 id="modalTitle">‚ûï Aggiungi Esercizio</h2>
            <form id="exerciseForm" onsubmit="saveExercise(event)">
                <input type="hidden" id="editIndex" value="-1">
                
                <div class="form-group">
                    <label>Nome esercizio *</label>
                    <input type="text" id="exName" required placeholder="es. Squat">
                </div>
                
                <div class="form-group">
                    <label>Descrizione</label>
                    <textarea id="exDesc" placeholder="Come eseguire l'esercizio..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="exType" onchange="toggleTypeFields()">
                        <option value="timer">‚è± Timer (secondi)</option>
                        <option value="reps">üî¢ Ripetizioni</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group" id="timerGroup">
                        <label>Durata (sec)</label>
                        <input type="number" id="exDuration" value="30" min="5" max="600">
                    </div>
                    <div class="form-group" id="repsGroup" style="display: none;">
                        <label>Ripetizioni</label>
                        <input type="number" id="exReps" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>Recupero (sec)</label>
                        <input type="number" id="exRest" value="15" min="0" max="300">
                    </div>
                </div>
                
                <div class="modal-btns">
                    <button type="button" class="btn secondary" onclick="closeModal()">Annulla</button>
                    <button type="submit" class="btn">üíæ Salva</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- New Workout Modal -->
    <div class="modal-overlay" id="newWorkoutModal">
        <div class="modal">
            <h2>üìã Nuovo Workout</h2>
            <form onsubmit="createWorkout(event)">
                <div class="form-group">
                    <label>Nome workout *</label>
                    <input type="text" id="newWorkoutName" required placeholder="es. Full Body">
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn secondary" onclick="closeNewWorkoutModal()">Annulla</button>
                    <button type="submit" class="btn">‚ú® Crea</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <h2>üì• Importa Workout</h2>
            <div class="form-group">
                <label>Incolla il codice workout di Patrick:</label>
                <textarea id="importCode" rows="5" placeholder="Incolla qui il codice..."></textarea>
            </div>
            <div class="modal-btns">
                <button class="btn secondary" onclick="closeImportModal()">Annulla</button>
                <button class="btn" onclick="importWorkout()">üì• Importa</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h2>üì§ Condividi Workout</h2>
            <div class="form-group">
                <label>Codice workout (copialo e condividilo):</label>
                <textarea id="exportCode" rows="5" readonly></textarea>
            </div>
            <div class="modal-btns">
                <button class="btn secondary" onclick="closeExportModal()">Chiudi</button>
                <button class="btn" onclick="copyExportCode()">üìã Copia</button>
            </div>
        </div>
    </div>
    
    <!-- Radio Audio Element -->
    <audio id="radioAudio" preload="none"></audio>

    <!-- Complete Modal -->
    <div class="modal-overlay" id="completeModal">
        <div class="modal">
            <div class="complete-screen">
                <div class="icon">üéâ</div>
                <h2>Workout Completato!</h2>
                <p>Ottimo lavoro!</p>
                <div class="stats">
                    <div class="stat">
                        <span>Esercizi</span>
                        <strong id="statExercises">0</strong>
                    </div>
                    <div class="stat">
                        <span>Tempo totale</span>
                        <strong id="statTime">0:00</strong>
                    </div>
                </div>
                <button class="btn success" style="width: 100%;" onclick="closeCompleteModal()">
                    üí™ Fatto!
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        let workouts = {};
        let currentWorkoutId = 'default';
        let currentExerciseIndex = 0;
        let timerInterval = null;
        let remainingTime = 0;
        let isPaused = false;
        let isResting = false;
        let wakeLock = null;
        let workoutStartTime = null;
        
        // Audio
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playBeep(freq = 800, duration = 200) {
            const oscillator = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            oscillator.connect(gain);
            gain.connect(audioCtx.destination);
            oscillator.frequency.value = freq;
            oscillator.type = 'sine';
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration/1000);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration/1000);
        }
        
        function playComplete() {
            playBeep(523, 150);
            setTimeout(() => playBeep(659, 150), 150);
            setTimeout(() => playBeep(784, 300), 300);
        }
        
        // Wake Lock
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                }
            } catch (err) {
                console.log('Wake Lock error:', err);
            }
        }
        
        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }
        
        // Storage
        function saveData() {
            localStorage.setItem('patrickWorkouts', JSON.stringify(workouts));
            localStorage.setItem('currentWorkoutId', currentWorkoutId);
        }
        
        function loadData() {
            const saved = localStorage.getItem('patrickWorkouts');
            if (saved) {
                workouts = JSON.parse(saved);
            } else {
                // Default workout - Pilates Strength TOUGH 11 Feb
                workouts = {
                    'default': {
                        name: 'üí™ Pilates TOUGH - 11 Feb',
                        exercises: [
                            // WARM-UP
                            {"name": "üî• WARM-UP", "description": "Get your body ready! 5 minutes to activate.", "type": "timer", "duration": 5, "rest": 0, "reps": 1},
                            {"name": "Marching in Place", "description": "March with high knees, pump your arms!", "type": "timer", "duration": 60, "rest": 5, "reps": 1},
                            {"name": "Leg Swings - Front/Back LEFT", "description": "Hold something for balance. Swing leg forward and back.", "type": "reps", "duration": 30, "reps": 10, "rest": 5},
                            {"name": "Leg Swings - Front/Back RIGHT", "description": "Switch legs. Control the movement.", "type": "reps", "duration": 30, "reps": 10, "rest": 5},
                            {"name": "Leg Swings - Side to Side LEFT", "description": "Swing leg across body and out to the side.", "type": "reps", "duration": 30, "reps": 10, "rest": 5},
                            {"name": "Leg Swings - Side to Side RIGHT", "description": "Switch legs. Keep core engaged.", "type": "reps", "duration": 30, "reps": 10, "rest": 5},
                            {"name": "Hip Circles LEFT", "description": "Hands on hips, circle your hips. Big circles!", "type": "reps", "duration": 30, "reps": 10, "rest": 5},
                            {"name": "Hip Circles RIGHT", "description": "Reverse direction.", "type": "reps", "duration": 30, "reps": 10, "rest": 10},
                            
                            // ROUND 1
                            {"name": "üî• ROUND 1 of 3", "description": "First round - FOCUS ON FORM! üí™", "type": "timer", "duration": 5, "rest": 0, "reps": 1},
                            {"name": "Single Leg Bridge - LEFT", "description": "12 reps + 10 PULSES at top. Squeeze glutes HARD!", "type": "reps", "duration": 45, "reps": 12, "rest": 5},
                            {"name": "Single Leg Bridge LEFT - PULSES", "description": "10 small pulses at the top. Don't drop!", "type": "reps", "duration": 20, "reps": 10, "rest": 10},
                            {"name": "Single Leg Bridge - RIGHT", "description": "12 reps + 10 PULSES. Keep hips level!", "type": "reps", "duration": 45, "reps": 12, "rest": 5},
                            {"name": "Single Leg Bridge RIGHT - PULSES", "description": "10 pulses. Feel the burn! üî•", "type": "reps", "duration": 20, "reps": 10, "rest": 15},
                            {"name": "Pilates Leg Curls - LEFT", "description": "15 reps + 10 PULSES. Control the movement!", "type": "reps", "duration": 45, "reps": 15, "rest": 5},
                            {"name": "Pilates Leg Curls LEFT - PULSES", "description": "10 small pulses. Hamstrings on fire!", "type": "reps", "duration": 20, "reps": 10, "rest": 10},
                            {"name": "Pilates Leg Curls - RIGHT", "description": "15 reps + 10 PULSES. Slow and controlled!", "type": "reps", "duration": 45, "reps": 15, "rest": 5},
                            {"name": "Pilates Leg Curls RIGHT - PULSES", "description": "10 pulses to finish!", "type": "reps", "duration": 20, "reps": 10, "rest": 15},
                            {"name": "Calf Raises (Relev√©s)", "description": "25 reps slow and controlled. Full range!", "type": "reps", "duration": 45, "reps": 25, "rest": 5},
                            {"name": "Calf Raises - HOLD", "description": "HOLD at the top for 10 seconds! üî•", "type": "timer", "duration": 10, "rest": 15, "reps": 1},
                            {"name": "Wall Sit", "description": "60 SECONDS - NO MERCY! üòà Thighs parallel to floor!", "type": "timer", "duration": 60, "rest": 15, "reps": 1},
                            {"name": "Swimming", "description": "15 reps each side. Opposite arm/leg lifts.", "type": "reps", "duration": 45, "reps": 15, "rest": 5},
                            {"name": "Swimming - Flutter Hold", "description": "10 second flutter kick hold! Core tight!", "type": "timer", "duration": 10, "rest": 45, "reps": 1},
                            
                            // ROUND 2
                            {"name": "üî• ROUND 2 of 3", "description": "Second round - PUSH THROUGH! üí™", "type": "timer", "duration": 5, "rest": 0, "reps": 1},
                            {"name": "Single Leg Bridge - LEFT", "description": "12 reps + 10 PULSES. You know the drill!", "type": "reps", "duration": 45, "reps": 12, "rest": 5},
                            {"name": "Single Leg Bridge LEFT - PULSES", "description": "10 pulses. Don't give up!", "type": "reps", "duration": 20, "reps": 10, "rest": 10},
                            {"name": "Single Leg Bridge - RIGHT", "description": "12 reps + 10 PULSES. Squeeze!", "type": "reps", "duration": 45, "reps": 12, "rest": 5},
                            {"name": "Single Leg Bridge RIGHT - PULSES", "description": "10 pulses. Halfway there!", "type": "reps", "duration": 20, "reps": 10, "rest": 15},
                            {"name": "Pilates Leg Curls - LEFT", "description": "15 reps + 10 PULSES. Stay strong!", "type": "reps", "duration": 45, "reps": 15, "rest": 5},
                            {"name": "Pilates Leg Curls LEFT - PULSES", "description": "10 pulses. Feel it!", "type": "reps", "duration": 20, "reps": 10, "rest": 10},
                            {"name": "Pilates Leg Curls - RIGHT", "description": "15 reps + 10 PULSES. Almost done with curls!", "type": "reps", "duration": 45, "reps": 15, "rest": 5},
                            {"name": "Pilates Leg Curls RIGHT - PULSES", "description": "10 final pulses!", "type": "reps", "duration": 20, "reps": 10, "rest": 15},
                            {"name": "Calf Raises (Relev√©s)", "description": "25 reps. Calves are burning! üî•", "type": "reps", "duration": 45, "reps": 25, "rest": 5},
                            {"name": "Calf Raises - HOLD", "description": "HOLD 10 seconds at the top!", "type": "timer", "duration": 10, "rest": 15, "reps": 1},
                            {"name": "Wall Sit", "description": "60 SECONDS AGAIN! üòà No excuses!", "type": "timer", "duration": 60, "rest": 15, "reps": 1},
                            {"name": "Swimming", "description": "15 reps each side. Keep that core engaged!", "type": "reps", "duration": 45, "reps": 15, "rest": 5},
                            {"name": "Swimming - Flutter Hold", "description": "10 second flutter hold!", "type": "timer", "duration": 10, "rest": 45, "reps": 1},
                            
                            // ROUND 3
                            {"name": "üî• ROUND 3 of 3 - FINAL!", "description": "LAST ROUND! Give it EVERYTHING! üí™üî•", "type": "timer", "duration": 5, "rest": 0, "reps": 1},
                            {"name": "Single Leg Bridge - LEFT", "description": "FINAL 12 reps + 10 PULSES!", "type": "reps", "duration": 45, "reps": 12, "rest": 5},
                            {"name": "Single Leg Bridge LEFT - PULSES", "description": "Last 10 pulses this side!", "type": "reps", "duration": 20, "reps": 10, "rest": 10},
                            {"name": "Single Leg Bridge - RIGHT", "description": "FINAL 12 reps + 10 PULSES!", "type": "reps", "duration": 45, "reps": 12, "rest": 5},
                            {"name": "Single Leg Bridge RIGHT - PULSES", "description": "Done with bridges after this! üéâ", "type": "reps", "duration": 20, "reps": 10, "rest": 15},
                            {"name": "Pilates Leg Curls - LEFT", "description": "FINAL 15 reps + 10 PULSES!", "type": "reps", "duration": 45, "reps": 15, "rest": 5},
                            {"name": "Pilates Leg Curls LEFT - PULSES", "description": "10 pulses - you're a warrior!", "type": "reps", "duration": 20, "reps": 10, "rest": 10},
                            {"name": "Pilates Leg Curls - RIGHT", "description": "LAST SET EVER! 15 reps + 10 PULSES!", "type": "reps", "duration": 45, "reps": 15, "rest": 5},
                            {"name": "Pilates Leg Curls RIGHT - PULSES", "description": "FINAL 10 pulses! You did it!", "type": "reps", "duration": 20, "reps": 10, "rest": 15},
                            {"name": "Calf Raises (Relev√©s)", "description": "FINAL 25 reps! Push through!", "type": "reps", "duration": 45, "reps": 25, "rest": 5},
                            {"name": "Calf Raises - HOLD", "description": "LAST HOLD - 10 seconds!", "type": "timer", "duration": 10, "rest": 15, "reps": 1},
                            {"name": "Wall Sit", "description": "FINAL 60 SECONDS! üòà YOU'VE GOT THIS!", "type": "timer", "duration": 60, "rest": 15, "reps": 1},
                            {"name": "Swimming", "description": "FINAL 15 reps each side!", "type": "reps", "duration": 45, "reps": 15, "rest": 5},
                            {"name": "Swimming - Flutter Hold", "description": "LAST flutter hold - 10 seconds!", "type": "timer", "duration": 10, "rest": 30, "reps": 1},
                            
                            // STRETCHING
                            {"name": "üßò STRETCHING TIME!", "description": "AMAZING JOB! üéâ Now let's recover those muscles. 10 min stretch.", "type": "timer", "duration": 5, "rest": 0, "reps": 1},
                            {"name": "Butterfly Stretch", "description": "Sit, soles of feet together. Gently press knees down. 45 sec.", "type": "timer", "duration": 45, "rest": 5, "reps": 1},
                            {"name": "Side Lunge - LEFT focus", "description": "Focus on left adductors. Go slow! 45 sec.", "type": "timer", "duration": 45, "rest": 5, "reps": 1},
                            {"name": "Supine IT Band Stretch - RIGHT", "description": "On back, right leg across body. Focus on IT band. 45 sec.", "type": "timer", "duration": 45, "rest": 5, "reps": 1},
                            {"name": "Pigeon Pose - LEFT", "description": "Deep hip opener. Breathe into it. 60 sec.", "type": "timer", "duration": 60, "rest": 5, "reps": 1},
                            {"name": "Pigeon Pose - RIGHT", "description": "Switch sides. Relax and breathe. 60 sec.", "type": "timer", "duration": 60, "rest": 5, "reps": 1},
                            {"name": "Quad Stretch - LEFT", "description": "Standing or lying. 30 sec each.", "type": "timer", "duration": 30, "rest": 5, "reps": 1},
                            {"name": "Quad Stretch - RIGHT", "description": "Switch legs. Feel the stretch.", "type": "timer", "duration": 30, "rest": 5, "reps": 1},
                            {"name": "Calf Stretch - LEFT", "description": "Against wall or step. 30 sec.", "type": "timer", "duration": 30, "rest": 5, "reps": 1},
                            {"name": "Calf Stretch - RIGHT", "description": "Switch legs.", "type": "timer", "duration": 30, "rest": 5, "reps": 1},
                            {"name": "Hip Flexor Stretch - LEFT", "description": "Lunge position, push hips forward. 30 sec.", "type": "timer", "duration": 30, "rest": 5, "reps": 1},
                            {"name": "Hip Flexor Stretch - RIGHT", "description": "Switch sides.", "type": "timer", "duration": 30, "rest": 5, "reps": 1},
                            {"name": "üéâ WORKOUT COMPLETE!", "description": "You're a BEAST! Patrick is proud of you! üí™üî•üíö", "type": "timer", "duration": 10, "rest": 0, "reps": 1}
                        ]
                    }
                };
            }
            currentWorkoutId = localStorage.getItem('currentWorkoutId') || 'default';
            if (!workouts[currentWorkoutId]) {
                currentWorkoutId = Object.keys(workouts)[0];
            }
        }
        
        function getCurrentWorkout() {
            return workouts[currentWorkoutId] || { name: 'Workout', exercises: [] };
        }
        
        // Render
        function renderWorkoutTabs() {
            const tabs = document.getElementById('workoutTabs');
            tabs.innerHTML = Object.entries(workouts).map(([id, w]) => `
                <button class="workout-tab ${id === currentWorkoutId ? 'active' : ''}" 
                        onclick="selectWorkout('${id}')">
                    ${w.name}
                    ${Object.keys(workouts).length > 1 ? `<span class="delete" onclick="event.stopPropagation(); deleteWorkout('${id}')">‚úï</span>` : ''}
                </button>
            `).join('');
        }
        
        function renderExercises() {
            const list = document.getElementById('exerciseList');
            const empty = document.getElementById('emptyState');
            const startBar = document.getElementById('startBar');
            const workout = getCurrentWorkout();
            
            if (workout.exercises.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                startBar.style.display = 'none';
                return;
            }
            
            empty.style.display = 'none';
            startBar.style.display = 'block';
            
            list.innerHTML = workout.exercises.map((ex, i) => `
                <div class="exercise-card" draggable="true" data-index="${i}">
                    <span class="drag-handle">‚ò∞</span>
                    <div class="info">
                        <div class="name">${ex.name}</div>
                        <div class="meta">
                            <span>${ex.type === 'timer' ? '‚è± ' + ex.duration + 's' : 'üî¢ ' + ex.reps + ' reps'}</span>
                            <span>üí§ ${ex.rest}s recupero</span>
                        </div>
                    </div>
                    <div class="actions">
                        <button onclick="editExercise(${i})">‚úèÔ∏è</button>
                        <button onclick="deleteExercise(${i})">üóë</button>
                    </div>
                </div>
            `).join('');
            
            // Drag & drop
            setupDragDrop();
        }
        
        function setupDragDrop() {
            const cards = document.querySelectorAll('.exercise-card');
            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });
        }
        
        let dragSrcIndex = null;
        
        function handleDragStart(e) {
            dragSrcIndex = parseInt(this.dataset.index);
            this.style.opacity = '0.4';
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            return false;
        }
        
        function handleDrop(e) {
            e.stopPropagation();
            const targetIndex = parseInt(this.dataset.index);
            if (dragSrcIndex !== targetIndex) {
                const workout = getCurrentWorkout();
                const [removed] = workout.exercises.splice(dragSrcIndex, 1);
                workout.exercises.splice(targetIndex, 0, removed);
                saveData();
                renderExercises();
            }
            return false;
        }
        
        function handleDragEnd(e) {
            this.style.opacity = '1';
        }
        
        // Modals
        function showAddExerciseModal() {
            document.getElementById('modalTitle').textContent = '‚ûï Aggiungi Esercizio';
            document.getElementById('editIndex').value = -1;
            document.getElementById('exerciseForm').reset();
            document.getElementById('exDuration').value = 30;
            document.getElementById('exReps').value = 10;
            document.getElementById('exRest').value = 15;
            toggleTypeFields();
            document.getElementById('exerciseModal').classList.add('active');
        }
        
        function editExercise(index) {
            const ex = getCurrentWorkout().exercises[index];
            document.getElementById('modalTitle').textContent = '‚úèÔ∏è Modifica Esercizio';
            document.getElementById('editIndex').value = index;
            document.getElementById('exName').value = ex.name;
            document.getElementById('exDesc').value = ex.description || '';
            document.getElementById('exType').value = ex.type;
            document.getElementById('exDuration').value = ex.duration || 30;
            document.getElementById('exReps').value = ex.reps || 10;
            document.getElementById('exRest').value = ex.rest || 15;
            toggleTypeFields();
            document.getElementById('exerciseModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }
        
        function toggleTypeFields() {
            const type = document.getElementById('exType').value;
            document.getElementById('timerGroup').style.display = type === 'timer' ? 'block' : 'none';
            document.getElementById('repsGroup').style.display = type === 'reps' ? 'block' : 'none';
        }
        
        function saveExercise(e) {
            e.preventDefault();
            const index = parseInt(document.getElementById('editIndex').value);
            const exercise = {
                name: document.getElementById('exName').value,
                description: document.getElementById('exDesc').value,
                type: document.getElementById('exType').value,
                duration: parseInt(document.getElementById('exDuration').value),
                reps: parseInt(document.getElementById('exReps').value),
                rest: parseInt(document.getElementById('exRest').value)
            };
            
            const workout = getCurrentWorkout();
            if (index === -1) {
                workout.exercises.push(exercise);
            } else {
                workout.exercises[index] = exercise;
            }
            
            saveData();
            renderExercises();
            closeModal();
        }
        
        function deleteExercise(index) {
            if (confirm('Eliminare questo esercizio?')) {
                getCurrentWorkout().exercises.splice(index, 1);
                saveData();
                renderExercises();
            }
        }
        
        // Workout Management
        function selectWorkout(id) {
            currentWorkoutId = id;
            saveData();
            renderWorkoutTabs();
            renderExercises();
        }
        
        function showNewWorkoutModal() {
            document.getElementById('newWorkoutName').value = '';
            document.getElementById('newWorkoutModal').classList.add('active');
        }
        
        function closeNewWorkoutModal() {
            document.getElementById('newWorkoutModal').classList.remove('active');
        }
        
        function createWorkout(e) {
            e.preventDefault();
            const name = document.getElementById('newWorkoutName').value;
            const id = 'workout_' + Date.now();
            workouts[id] = { name, exercises: [] };
            currentWorkoutId = id;
            saveData();
            renderWorkoutTabs();
            renderExercises();
            closeNewWorkoutModal();
        }
        
        function deleteWorkout(id) {
            if (Object.keys(workouts).length <= 1) {
                alert('Devi avere almeno un workout!');
                return;
            }
            if (confirm('Eliminare questo workout?')) {
                delete workouts[id];
                if (currentWorkoutId === id) {
                    currentWorkoutId = Object.keys(workouts)[0];
                }
                saveData();
                renderWorkoutTabs();
                renderExercises();
            }
        }
        
        function deleteCurrentWorkout() {
            const workout = getCurrentWorkout();
            if (Object.keys(workouts).length <= 1) {
                // If only one workout, just clear exercises
                if (confirm('Vuoi svuotare tutti gli esercizi?')) {
                    workouts[currentWorkoutId].exercises = [];
                    saveData();
                    renderExercises();
                    alert('Workout svuotato!');
                }
                return;
            }
            if (confirm(`Eliminare "${workout.name}"?`)) {
                delete workouts[currentWorkoutId];
                currentWorkoutId = Object.keys(workouts)[0];
                saveData();
                renderWorkoutTabs();
                renderExercises();
                alert('Workout eliminato!');
            }
        }
        
        // Import/Export
        function showImportModal() {
            document.getElementById('importCode').value = '';
            document.getElementById('importModal').classList.add('active');
        }
        
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }
        
        function importWorkout() {
            try {
                const code = document.getElementById('importCode').value.trim();
                // Try UTF-8 safe decode first, fallback to regular atob
                let jsonStr;
                try {
                    jsonStr = base64ToUtf8(code);
                } catch (e) {
                    jsonStr = atob(code);
                }
                const data = JSON.parse(jsonStr);
                if (data.name && data.exercises) {
                    const id = 'workout_' + Date.now();
                    workouts[id] = data;
                    currentWorkoutId = id;
                    saveData();
                    renderWorkoutTabs();
                    renderExercises();
                    closeImportModal();
                    alert('Workout importato! üéâ');
                } else {
                    throw new Error('Invalid format');
                }
            } catch (err) {
                alert('Codice non valido. Controlla e riprova.');
            }
        }
        
        // UTF-8 safe base64 encode/decode
        function utf8ToBase64(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                return String.fromCharCode('0x' + p1);
            }));
        }
        
        function base64ToUtf8(str) {
            return decodeURIComponent(atob(str).split('').map(c => {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }
        
        function showExportModal() {
            try {
                const workout = getCurrentWorkout();
                const code = utf8ToBase64(JSON.stringify(workout));
                document.getElementById('exportCode').value = code;
                document.getElementById('exportModal').classList.add('active');
            } catch (err) {
                alert('Errore export: ' + err.message);
            }
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }
        
        function copyExportCode() {
            const code = document.getElementById('exportCode');
            code.select();
            document.execCommand('copy');
            alert('Codice copiato! üìã');
        }
        
        // Exercise Animation Mapping with Real Images from free-exercise-db
        const EXERCISE_DB_BASE = 'https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/';
        
        // Map exercise names to database IDs
        const exerciseImageMap = {
            // Squat variations
            'squat': 'Bodyweight_Squat',
            'wall sit': 'Bodyweight_Squat',
            'jump squat': 'Bodyweight_Squat',
            
            // Lunges
            'lunge': 'Bodyweight_Walking_Lunge',
            'affond': 'Bodyweight_Walking_Lunge',
            
            // Bridge
            'bridge': 'Butt_Lift_Bridge',
            'ponte': 'Butt_Lift_Bridge',
            'glute bridge': 'Butt_Lift_Bridge',
            
            // Leg Curls
            'leg curl': 'Ball_Leg_Curl',
            'curl': 'Ball_Leg_Curl',
            
            // Calf
            'calf': 'Standing_Calf_Raises',
            'relev': 'Standing_Calf_Raises',
            'polpacc': 'Standing_Calf_Raises',
            
            // Swimming (back exercise)
            'swim': 'Superman',
            
            // Crunch / Abs
            'crunch': 'Crunch_-_Hands_Overhead',
            'bicicl': 'Air_Bike',
            
            // Core / Abs - new additions
            'dead bug': 'Dead_Bug',
            'hollow': 'Flutter_Kicks',
            'hollow hold': 'Flutter_Kicks',
            
            // Stretching
            'stretch': 'Cat_Stretch',
            'child': 'Childs_Pose',
            'butterfly': 'Butterfly',
            'yoga': 'Cat_Stretch',
            'figure 4': 'Piriformis-SMR',
            
            // Default
            'default': 'Bodyweight_Squat'
        };
        
        let animationInterval = null;
        
        function getExerciseImageId(name) {
            const n = name.toLowerCase();
            for (const [keyword, imageId] of Object.entries(exerciseImageMap)) {
                if (n.includes(keyword)) {
                    return imageId;
                }
            }
            return null; // No image found, will use emoji fallback
        }
        
        function getExerciseEmoji(name) {
            const n = name.toLowerCase();
            if (n.includes('recupero') || n.includes('rest') || n.includes('üí§')) return 'üòå';
            if (n.includes('stretch') || n.includes('yoga')) return 'üßò';
            if (n.includes('squat')) return 'üèãÔ∏è';
            if (n.includes('lunge') || n.includes('affond')) return 'ü¶µ';
            if (n.includes('bridge') || n.includes('ponte')) return 'üåâ';
            if (n.includes('curl')) return 'ü¶ø';
            if (n.includes('calf') || n.includes('relev')) return 'ü¶∂';
            if (n.includes('swim')) return 'üèä';
            if (n.includes('crunch') || n.includes('bicicl')) return 'üí™';
            if (n.includes('round') || n.includes('üî•')) return 'üî•';
            return 'üí™';
        }
        
        function startExerciseAnimation(exerciseName) {
            const animDiv = document.getElementById('exerciseAnimation');
            const imageId = getExerciseImageId(exerciseName);
            
            // Stop any existing animation
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            
            if (imageId) {
                // Use real images
                const img0 = EXERCISE_DB_BASE + imageId + '/0.jpg';
                const img1 = EXERCISE_DB_BASE + imageId + '/1.jpg';
                
                animDiv.innerHTML = `<img id="exerciseImg" src="${img0}" alt="${exerciseName}" onerror="this.parentElement.innerHTML='<span class=\\'emoji-fallback\\'>${getExerciseEmoji(exerciseName)}</span>'">`;
                
                let showingFirst = true;
                animationInterval = setInterval(() => {
                    const img = document.getElementById('exerciseImg');
                    if (img) {
                        showingFirst = !showingFirst;
                        img.src = showingFirst ? img0 : img1;
                    }
                }, 800); // Alternate every 800ms
            } else {
                // Fallback to emoji
                animDiv.innerHTML = `<span class="emoji-fallback">${getExerciseEmoji(exerciseName)}</span>`;
            }
        }
        
        // Workout Execution
        function startWorkout() {
            const workout = getCurrentWorkout();
            if (workout.exercises.length === 0) return;
            
            currentExerciseIndex = 0;
            isResting = false;
            isPaused = false;
            workoutStartTime = Date.now();
            
            document.getElementById('listView').classList.remove('active');
            document.getElementById('workoutView').classList.add('active');
            
            requestWakeLock();
            audioCtx.resume();
            showCurrentExercise();
            
            // Auto-load radio stations (energy by default)
            loadGenre('energy', document.querySelector('.genre-tab'));
        }
        
        function exitWorkout() {
            if (confirm('Vuoi uscire dall\'allenamento?')) {
                stopTimer();
                if (animationInterval) {
                    clearInterval(animationInterval);
                    animationInterval = null;
                }
                stopRadio();
                releaseWakeLock();
                document.getElementById('workoutView').classList.remove('active');
                document.getElementById('listView').classList.add('active');
            }
        }
        
        function showCurrentExercise() {
            const workout = getCurrentWorkout();
            const ex = workout.exercises[currentExerciseIndex];
            
            const main = document.getElementById('workoutMain');
            main.className = 'workout-main fade-in' + (isResting ? ' rest-screen' : '');
            
            document.getElementById('progressText').textContent = 
                `${currentExerciseIndex + 1}/${workout.exercises.length}`;
            document.getElementById('progressFill').style.width = 
                `${((currentExerciseIndex + 1) / workout.exercises.length) * 100}%`;
            
            if (isResting) {
                document.getElementById('currentExerciseName').textContent = 'üí§ Recupero';
                document.getElementById('currentExerciseDesc').innerHTML = 
                    `<div class="next-up"><div class="label">Prossimo:</div><div class="name">${
                        currentExerciseIndex + 1 < workout.exercises.length 
                            ? workout.exercises[currentExerciseIndex + 1].name 
                            : 'üéâ Fine!'
                    }</div></div>`;
                // Show next exercise preview during rest
                const nextEx = currentExerciseIndex + 1 < workout.exercises.length 
                    ? workout.exercises[currentExerciseIndex + 1].name : null;
                if (nextEx) {
                    startExerciseAnimation(nextEx);
                } else {
                    document.getElementById('exerciseAnimation').innerHTML = '<span class="emoji-fallback">üéâ</span>';
                }
                startTimer(ex.rest);
            } else {
                startExerciseAnimation(ex.name);
                document.getElementById('currentExerciseName').textContent = ex.name;
                document.getElementById('currentExerciseDesc').textContent = ex.description || '';
                
                if (ex.type === 'timer') {
                    startTimer(ex.duration);
                } else {
                    // Reps mode - show reps, manual advance
                    document.getElementById('timerDisplay').innerHTML = 
                        `<div class="reps-display">${ex.reps} <span>reps</span></div>`;
                    document.getElementById('playPauseBtn').textContent = '‚úì';
                }
            }
            
            playBeep(600, 100);
        }
        
        function startTimer(seconds) {
            stopTimer();
            remainingTime = seconds;
            updateTimerDisplay();
            document.getElementById('playPauseBtn').textContent = '‚è∏';
            
            timerInterval = setInterval(() => {
                if (!isPaused) {
                    remainingTime--;
                    updateTimerDisplay();
                    
                    // Countdown beeps for last 5 seconds
                    if (remainingTime <= 5 && remainingTime > 0) {
                        if (remainingTime <= 3) {
                            // Last 3 seconds: higher pitch, louder
                            playBeep(800, 150);
                        } else {
                            // 5 and 4 seconds: lower pitch
                            playBeep(500, 100);
                        }
                    }
                    
                    if (remainingTime <= 0) {
                        stopTimer();
                        playComplete();
                        
                        // Vibrate if available
                        if ('vibrate' in navigator) {
                            navigator.vibrate([200, 100, 200]);
                        }
                        
                        advanceExercise();
                    }
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function updateTimerDisplay() {
            const mins = Math.floor(remainingTime / 60);
            const secs = remainingTime % 60;
            document.getElementById('timerDisplay').textContent = 
                `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function togglePause() {
            const workout = getCurrentWorkout();
            const ex = workout.exercises[currentExerciseIndex];
            
            if (ex.type === 'reps' && !isResting) {
                // Manual complete for reps
                advanceExercise();
                return;
            }
            
            isPaused = !isPaused;
            document.getElementById('playPauseBtn').textContent = isPaused ? '‚ñ∂' : '‚è∏';
            
            if (isPaused) {
                document.getElementById('playPauseBtn').classList.add('pulse');
            } else {
                document.getElementById('playPauseBtn').classList.remove('pulse');
            }
        }
        
        function advanceExercise() {
            const workout = getCurrentWorkout();
            
            if (isResting) {
                // Move to next exercise
                currentExerciseIndex++;
                isResting = false;
                
                if (currentExerciseIndex >= workout.exercises.length) {
                    completeWorkout();
                    return;
                }
            } else {
                // Start rest period
                const ex = workout.exercises[currentExerciseIndex];
                if (ex.rest > 0) {
                    isResting = true;
                } else {
                    // No rest, go to next
                    currentExerciseIndex++;
                    if (currentExerciseIndex >= workout.exercises.length) {
                        completeWorkout();
                        return;
                    }
                }
            }
            
            showCurrentExercise();
        }
        
        function nextExercise() {
            stopTimer();
            isResting = false;
            currentExerciseIndex++;
            
            const workout = getCurrentWorkout();
            if (currentExerciseIndex >= workout.exercises.length) {
                completeWorkout();
                return;
            }
            
            showCurrentExercise();
        }
        
        function prevExercise() {
            stopTimer();
            isResting = false;
            if (currentExerciseIndex > 0) {
                currentExerciseIndex--;
            }
            showCurrentExercise();
        }
        
        function completeWorkout() {
            stopTimer();
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            releaseWakeLock();
            
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            
            document.getElementById('statExercises').textContent = getCurrentWorkout().exercises.length;
            document.getElementById('statTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            document.getElementById('workoutView').classList.remove('active');
            document.getElementById('listView').classList.add('active');
            document.getElementById('completeModal').classList.add('active');
            
            playComplete();
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 400]);
            }
        }
        
        function closeCompleteModal() {
            document.getElementById('completeModal').classList.remove('active');
        }
        
        // Check for workout code in URL
        function checkUrlImport() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('w');
            if (code) {
                try {
                    // Try UTF-8 safe decode first, fallback to regular atob
                    let jsonStr;
                    try {
                        jsonStr = base64ToUtf8(code);
                    } catch (e) {
                        jsonStr = atob(code);
                    }
                    const data = JSON.parse(jsonStr);
                    if (data.name && data.exercises) {
                        const id = 'workout_' + Date.now();
                        workouts[id] = data;
                        currentWorkoutId = id;
                        // Save multiple times to ensure persistence
                        saveData();
                        localStorage.setItem('patrickWorkouts', JSON.stringify(workouts));
                        localStorage.setItem('currentWorkoutId', currentWorkoutId);
                        // Clean URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        alert(`Workout "${data.name}" importato e salvato! üéâ\n\n${data.exercises.length} esercizi caricati.`);
                    }
                } catch (err) {
                    console.log('Invalid URL workout code:', err);
                    alert('Codice workout non valido!');
                }
            }
        }
        
        // Debug function to check storage
        function checkStorage() {
            const saved = localStorage.getItem('patrickWorkouts');
            console.log('Stored workouts:', saved);
            alert('Workout salvati: ' + Object.keys(workouts).length + '\nWorkout corrente: ' + getCurrentWorkout().name);
        }
        
        // === MJ RADIO ===
        const RADIO_API = 'https://de1.api.radio-browser.info/json';
        const radioAudio = document.getElementById('radioAudio');
        let currentStation = null;

        const GENRES = {
            energy: { tags: 'workout,fitness,energy', fallback: 'dance,electronic,edm', name: 'Energy' },
            chill: { tags: 'chill,chillout,ambient,lounge', fallback: 'yoga,meditation,relaxation', name: 'Chill' },
            hiphop: { tags: 'hip hop,hiphop,rap', fallback: 'urban,r&b,rnb', name: 'Hip-Hop' },
            dance: { tags: 'dance,house,edm,electronic', fallback: 'club,techno,trance', name: 'Dance' }
        };

        function toggleRadioPanel() {
            const panel = document.getElementById('radioPlayer');
            const btn = document.getElementById('radioToggleBtn');
            panel.classList.toggle('visible');
            btn.classList.toggle('radio-on', panel.classList.contains('visible'));
        }

        async function loadGenre(genre, tabEl) {
            document.querySelectorAll('.genre-tab').forEach(t => t.classList.remove('active'));
            if (tabEl) tabEl.classList.add('active');

            const list = document.getElementById('stationList');
            list.innerHTML = '<div style="text-align:center;opacity:0.5;padding:20px;">Caricamento...</div>';

            const g = GENRES[genre];
            let stations = [];

            for (const tagSet of [g.tags, g.fallback]) {
                for (const tag of tagSet.split(',')) {
                    try {
                        const resp = await fetch(`${RADIO_API}/stations/search?tag=${tag.trim()}&limit=15&order=clickcount&reverse=true&lastcheckok=1`);
                        const data = await resp.json();
                        const https = data.filter(s => s.url_resolved?.startsWith('https'));
                        stations = [...stations, ...https];
                    } catch(e) {}
                }
                if (stations.length >= 5) break;
            }

            const seen = new Set();
            stations = stations.filter(s => {
                const key = s.name.toLowerCase().trim();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            }).slice(0, 12);

            list.innerHTML = stations.map((s, i) => `
                <div class="station-item" id="st-${i}" onclick='playStation(${JSON.stringify({
                    name: s.name, url: s.url_resolved || s.url, favicon: s.favicon, tags: s.tags
                }).replace(/'/g, "\\'")}, ${i})'>
                    <div class="station-logo">
                        ${s.favicon ? `<img src="${s.favicon}" onerror="this.parentElement.textContent='üìª'">` : 'üìª'}
                    </div>
                    <div>
                        <div class="station-name">${s.name.substring(0, 30)}</div>
                        <div class="station-tags">${(s.tags || '').split(',').slice(0,3).join(', ')}</div>
                    </div>
                </div>
            `).join('');
        }

        function playStation(station, idx) {
            radioAudio.pause();
            radioAudio.src = '';
            document.querySelectorAll('.station-item').forEach(s => s.classList.remove('playing'));

            radioAudio.src = station.url;
            radioAudio.volume = document.getElementById('radioVolume').value / 100;
            radioAudio.play().catch(e => console.log('Radio play error:', e));

            currentStation = station;
            document.getElementById(`st-${idx}`).classList.add('playing');

            document.getElementById('npName').textContent = station.name;
            document.getElementById('npGenre').textContent = station.tags?.split(',').slice(0,3).join(', ') || '';
            document.getElementById('nowPlaying').classList.add('active');

            // Update toggle button to show radio is on
            document.getElementById('radioToggleBtn').classList.add('radio-on');
        }

        function stopRadio() {
            radioAudio.pause();
            radioAudio.src = '';
            currentStation = null;
            document.querySelectorAll('.station-item').forEach(s => s.classList.remove('playing'));
            document.getElementById('nowPlaying').classList.remove('active');
            document.getElementById('radioToggleBtn').classList.remove('radio-on');
        }

        function setRadioVolume(val) {
            radioAudio.volume = val / 100;
        }

        // Init
        loadData();
        checkUrlImport();
        renderWorkoutTabs();
        renderExercises();
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
        }
    </script>
</body>
</html>
