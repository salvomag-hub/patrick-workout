<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>üí™ Patrick Workout</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #e94560;
            --secondary: #0f3460;
            --bg: #1a1a2e;
            --card: #16213e;
            --text: #eaeaea;
            --success: #4ecca3;
            --warning: #ffc107;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: var(--card);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-btns {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.1s, opacity 0.2s;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn.secondary {
            background: var(--secondary);
        }
        
        .btn.success {
            background: var(--success);
            color: #1a1a2e;
        }
        
        /* Views */
        .view {
            display: none;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .view.active {
            display: block;
        }
        
        /* Exercise List */
        .exercise-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .exercise-card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .exercise-card:active {
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.3);
        }
        
        .exercise-card .drag-handle {
            color: #666;
            font-size: 1.2rem;
        }
        
        .exercise-card .info {
            flex: 1;
        }
        
        .exercise-card .name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        
        .exercise-card .meta {
            font-size: 0.85rem;
            color: #aaa;
            display: flex;
            gap: 12px;
        }
        
        .exercise-card .actions {
            display: flex;
            gap: 8px;
        }
        
        .exercise-card .actions button {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }
        
        .exercise-card .actions button:hover {
            color: var(--primary);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-row {
            display: flex;
            gap: 12px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .modal-btns {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .modal-btns .btn {
            flex: 1;
            justify-content: center;
        }
        
        /* Workout View */
        #workoutView {
            padding: 0;
            height: 100vh;
            display: none;
            flex-direction: column;
        }
        
        #workoutView.active {
            display: flex;
        }
        
        .workout-header {
            background: var(--card);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .workout-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            width: 100px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar .fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }
        
        .workout-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }
        
        .exercise-name {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .exercise-description {
            font-size: 1.1rem;
            color: #ccc;
            margin-bottom: 40px;
            line-height: 1.6;
            max-width: 400px;
        }
        
        .timer-display {
            font-size: 6rem;
            font-weight: 200;
            font-variant-numeric: tabular-nums;
            margin-bottom: 20px;
        }
        
        .reps-display {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .reps-display span {
            font-size: 1.5rem;
            color: #888;
        }
        
        .workout-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        
        .workout-controls .btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 1.8rem;
            justify-content: center;
        }
        
        .workout-controls .btn.large {
            width: 90px;
            height: 90px;
            font-size: 2.2rem;
        }
        
        /* Rest Screen */
        .rest-screen {
            background: var(--secondary);
        }
        
        .rest-screen .exercise-name {
            color: var(--success);
        }
        
        .next-up {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .next-up .label {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 8px;
        }
        
        .next-up .name {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        /* Complete Screen */
        .complete-screen {
            text-align: center;
            padding: 40px;
        }
        
        .complete-screen .icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        
        .complete-screen h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--success);
        }
        
        .complete-screen .stats {
            margin: 30px 0;
            padding: 20px;
            background: var(--card);
            border-radius: 12px;
        }
        
        .complete-screen .stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        
        .complete-screen .stat:last-child {
            border-bottom: none;
        }
        
        /* FAB */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
            z-index: 50;
        }
        
        /* Import/Export */
        .import-section {
            margin-top: 30px;
            padding: 20px;
            background: var(--card);
            border-radius: 12px;
        }
        
        .import-section h3 {
            margin-bottom: 15px;
            font-size: 1rem;
        }
        
        .import-section .code-input {
            display: flex;
            gap: 10px;
        }
        
        .import-section input {
            flex: 1;
        }
        
        /* Workout Select */
        .workout-select {
            margin-bottom: 20px;
        }
        
        .workout-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .workout-tab {
            background: var(--card);
            border: 2px solid transparent;
            color: var(--text);
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .workout-tab.active {
            border-color: var(--primary);
            background: rgba(233, 69, 96, 0.2);
        }
        
        .workout-tab .delete {
            margin-left: 8px;
            opacity: 0.5;
        }
        
        .workout-tab .delete:hover {
            opacity: 1;
        }

        /* Start Workout Button */
        .start-workout-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(transparent, var(--bg) 30%);
            z-index: 50;
        }
        
        .start-workout-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        /* Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Exercise Animations */
        .exercise-animation {
            font-size: 5rem;
            margin-bottom: 20px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes squat {
            0%, 100% { transform: translateY(0) scaleY(1); }
            50% { transform: translateY(15px) scaleY(0.85); }
        }
        
        @keyframes lunge {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }
        
        @keyframes bridge {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(-10deg); }
        }
        
        @keyframes curl {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(20deg); }
        }
        
        @keyframes calf {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes wallsit {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        @keyframes swim {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        
        @keyframes stretch {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes rest {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .anim-squat { animation: squat 1.5s ease-in-out infinite; }
        .anim-lunge { animation: lunge 1.2s ease-in-out infinite; }
        .anim-bridge { animation: bridge 1.5s ease-in-out infinite; }
        .anim-curl { animation: curl 1s ease-in-out infinite; }
        .anim-calf { animation: calf 1s ease-in-out infinite; }
        .anim-wallsit { animation: wallsit 2s ease-in-out infinite; }
        .anim-swim { animation: swim 1s ease-in-out infinite; }
        .anim-stretch { animation: stretch 2s ease-in-out infinite; }
        .anim-rest { animation: rest 1.5s ease-in-out infinite; }
        .anim-bounce { animation: bounce 0.8s ease-in-out infinite; }
    </style>
</head>
<body>
    <!-- Main List View -->
    <div id="listView" class="view active">
        <div class="header">
            <h1>üí™ Patrick Workout</h1>
            <div class="header-btns">
                <button class="btn secondary" onclick="showImportModal()">üì•</button>
                <button class="btn secondary" onclick="showExportModal()">üì§</button>
            </div>
        </div>
        
        <div style="padding: 20px;">
            <div class="workout-select">
                <div class="workout-tabs" id="workoutTabs"></div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn secondary" style="flex: 1;" onclick="showNewWorkoutModal()">
                        ‚ûï Nuovo
                    </button>
                    <button class="btn" style="flex: 1; background: #c0392b;" onclick="deleteCurrentWorkout()">
                        üóë Elimina
                    </button>
                </div>
            </div>
            
            <div class="exercise-list" id="exerciseList"></div>
            
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="icon">üèãÔ∏è</div>
                <h3>Nessun esercizio</h3>
                <p style="margin-top: 10px;">Aggiungi il tuo primo esercizio!</p>
            </div>
        </div>
        
        <button class="fab" onclick="showAddExerciseModal()">+</button>
        
        <div class="start-workout-bar" id="startBar" style="display: none;">
            <button class="btn success start-workout-btn" onclick="startWorkout()">
                ‚ñ∂Ô∏è Inizia Allenamento
            </button>
        </div>
    </div>
    
    <!-- Workout View -->
    <div id="workoutView" class="view">
        <div class="workout-header">
            <button class="btn secondary" onclick="exitWorkout()">‚úï Esci</button>
            <div class="workout-progress">
                <span id="progressText">1/5</span>
                <div class="progress-bar">
                    <div class="fill" id="progressFill" style="width: 20%"></div>
                </div>
            </div>
        </div>
        
        <div class="workout-main" id="workoutMain">
            <div class="exercise-animation" id="exerciseAnimation">üèãÔ∏è</div>
            <div class="exercise-name" id="currentExerciseName">Squat</div>
            <div class="exercise-description" id="currentExerciseDesc">
                Piedi larghezza spalle, scendi fino a cosce parallele al suolo.
            </div>
            <div class="timer-display" id="timerDisplay">0:30</div>
            <div class="workout-controls">
                <button class="btn secondary" onclick="prevExercise()">‚èÆ</button>
                <button class="btn large" id="playPauseBtn" onclick="togglePause()">‚è∏</button>
                <button class="btn secondary" onclick="nextExercise()">‚è≠</button>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Exercise Modal -->
    <div class="modal-overlay" id="exerciseModal">
        <div class="modal">
            <h2 id="modalTitle">‚ûï Aggiungi Esercizio</h2>
            <form id="exerciseForm" onsubmit="saveExercise(event)">
                <input type="hidden" id="editIndex" value="-1">
                
                <div class="form-group">
                    <label>Nome esercizio *</label>
                    <input type="text" id="exName" required placeholder="es. Squat">
                </div>
                
                <div class="form-group">
                    <label>Descrizione</label>
                    <textarea id="exDesc" placeholder="Come eseguire l'esercizio..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="exType" onchange="toggleTypeFields()">
                        <option value="timer">‚è± Timer (secondi)</option>
                        <option value="reps">üî¢ Ripetizioni</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group" id="timerGroup">
                        <label>Durata (sec)</label>
                        <input type="number" id="exDuration" value="30" min="5" max="600">
                    </div>
                    <div class="form-group" id="repsGroup" style="display: none;">
                        <label>Ripetizioni</label>
                        <input type="number" id="exReps" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>Recupero (sec)</label>
                        <input type="number" id="exRest" value="15" min="0" max="300">
                    </div>
                </div>
                
                <div class="modal-btns">
                    <button type="button" class="btn secondary" onclick="closeModal()">Annulla</button>
                    <button type="submit" class="btn">üíæ Salva</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- New Workout Modal -->
    <div class="modal-overlay" id="newWorkoutModal">
        <div class="modal">
            <h2>üìã Nuovo Workout</h2>
            <form onsubmit="createWorkout(event)">
                <div class="form-group">
                    <label>Nome workout *</label>
                    <input type="text" id="newWorkoutName" required placeholder="es. Full Body">
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn secondary" onclick="closeNewWorkoutModal()">Annulla</button>
                    <button type="submit" class="btn">‚ú® Crea</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <h2>üì• Importa Workout</h2>
            <div class="form-group">
                <label>Incolla il codice workout di Patrick:</label>
                <textarea id="importCode" rows="5" placeholder="Incolla qui il codice..."></textarea>
            </div>
            <div class="modal-btns">
                <button class="btn secondary" onclick="closeImportModal()">Annulla</button>
                <button class="btn" onclick="importWorkout()">üì• Importa</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h2>üì§ Condividi Workout</h2>
            <div class="form-group">
                <label>Codice workout (copialo e condividilo):</label>
                <textarea id="exportCode" rows="5" readonly></textarea>
            </div>
            <div class="modal-btns">
                <button class="btn secondary" onclick="closeExportModal()">Chiudi</button>
                <button class="btn" onclick="copyExportCode()">üìã Copia</button>
            </div>
        </div>
    </div>
    
    <!-- Complete Modal -->
    <div class="modal-overlay" id="completeModal">
        <div class="modal">
            <div class="complete-screen">
                <div class="icon">üéâ</div>
                <h2>Workout Completato!</h2>
                <p>Ottimo lavoro!</p>
                <div class="stats">
                    <div class="stat">
                        <span>Esercizi</span>
                        <strong id="statExercises">0</strong>
                    </div>
                    <div class="stat">
                        <span>Tempo totale</span>
                        <strong id="statTime">0:00</strong>
                    </div>
                </div>
                <button class="btn success" style="width: 100%;" onclick="closeCompleteModal()">
                    üí™ Fatto!
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        let workouts = {};
        let currentWorkoutId = 'default';
        let currentExerciseIndex = 0;
        let timerInterval = null;
        let remainingTime = 0;
        let isPaused = false;
        let isResting = false;
        let wakeLock = null;
        let workoutStartTime = null;
        
        // Audio
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playBeep(freq = 800, duration = 200) {
            const oscillator = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            oscillator.connect(gain);
            gain.connect(audioCtx.destination);
            oscillator.frequency.value = freq;
            oscillator.type = 'sine';
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration/1000);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration/1000);
        }
        
        function playComplete() {
            playBeep(523, 150);
            setTimeout(() => playBeep(659, 150), 150);
            setTimeout(() => playBeep(784, 300), 300);
        }
        
        // Wake Lock
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                }
            } catch (err) {
                console.log('Wake Lock error:', err);
            }
        }
        
        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }
        
        // Storage
        function saveData() {
            localStorage.setItem('patrickWorkouts', JSON.stringify(workouts));
            localStorage.setItem('currentWorkoutId', currentWorkoutId);
        }
        
        function loadData() {
            const saved = localStorage.getItem('patrickWorkouts');
            if (saved) {
                workouts = JSON.parse(saved);
            } else {
                // Default workout - Pilates Strength 9 Feb
                workouts = {
                    'default': {
                        name: 'Pilates Strength - 9 Feb',
                        exercises: [
                            {"name": "üî• ROUND 1", "description": "First round - focus on form!", "type": "timer", "duration": 5, "rest": 0, "reps": 1},
                            {"name": "Single Leg Bridge - LEFT", "description": "Supina, solleva una gamba. Spingi col tallone a terra e solleva il bacino. Core attivo!", "type": "reps", "duration": 30, "reps": 12, "rest": 10},
                            {"name": "Single Leg Bridge - RIGHT", "description": "Cambia gamba. Mantieni il bacino stabile, non ruotare.", "type": "reps", "duration": 30, "reps": 12, "rest": 15},
                            {"name": "Pilates Leg Curls - LEFT", "description": "Prona, piega la gamba portando il tallone verso il gluteo. Movimento lento e controllato.", "type": "reps", "duration": 30, "reps": 15, "rest": 10},
                            {"name": "Pilates Leg Curls - RIGHT", "description": "Cambia gamba. Senti lavorare i femorali.", "type": "reps", "duration": 30, "reps": 15, "rest": 15},
                            {"name": "Calf Raises (Relev√©s)", "description": "In piedi, solleva sui polpacci. Sali lentamente, scendi controllando.", "type": "reps", "duration": 30, "reps": 20, "rest": 15},
                            {"name": "Wall Sit", "description": "Schiena al muro, cosce parallele al pavimento. Tieni duro! üí™", "type": "timer", "duration": 45, "rest": 15, "reps": 1},
                            {"name": "Swimming", "description": "Prona, braccia e gambe estese. Alterna braccio dx/gamba sx. Core sempre attivo!", "type": "reps", "duration": 30, "reps": 10, "rest": 60},
                            {"name": "üî• ROUND 2", "description": "Second round - push through!", "type": "timer", "duration": 5, "rest": 0, "reps": 1},
                            {"name": "Single Leg Bridge - LEFT", "description": "Round 2! Mantieni la qualit√† del movimento.", "type": "reps", "duration": 30, "reps": 12, "rest": 10},
                            {"name": "Single Leg Bridge - RIGHT", "description": "Ultima serie bridges! Stringi i glutei.", "type": "reps", "duration": 30, "reps": 12, "rest": 15},
                            {"name": "Pilates Leg Curls - LEFT", "description": "Round 2. Movimento controllato!", "type": "reps", "duration": 30, "reps": 15, "rest": 10},
                            {"name": "Pilates Leg Curls - RIGHT", "description": "Ultima serie curls! Senti il bruciore üî•", "type": "reps", "duration": 30, "reps": 15, "rest": 15},
                            {"name": "Calf Raises (Relev√©s)", "description": "Round 2 - polpacci in fiamme! üî•", "type": "reps", "duration": 30, "reps": 20, "rest": 15},
                            {"name": "Wall Sit", "description": "Ultimo wall sit! Non mollare! üí™", "type": "timer", "duration": 45, "rest": 15, "reps": 1},
                            {"name": "Swimming", "description": "Ultimo esercizio del workout! Dai tutto!", "type": "reps", "duration": 30, "reps": 10, "rest": 30},
                            {"name": "üßò STRETCHING", "description": "Great job! Now let's stretch those muscles.", "type": "timer", "duration": 5, "rest": 0, "reps": 1},
                            {"name": "Butterfly Stretch", "description": "Seduta, piante dei piedi unite, ginocchia aperte. Spingi delicatamente le ginocchia verso il basso.", "type": "timer", "duration": 45, "rest": 5, "reps": 1},
                            {"name": "Side Lunge - LEFT focus", "description": "Affondo laterale a sinistra. Attenzione agli adduttori - vai piano!", "type": "timer", "duration": 45, "rest": 5, "reps": 1},
                            {"name": "Supine IT Band Stretch - RIGHT", "description": "Supina, gamba destra sul petto, poi portala verso sinistra. Focus sulla bandelletta.", "type": "timer", "duration": 45, "rest": 5, "reps": 1},
                            {"name": "Figure 4 Stretch - LEFT", "description": "Supina, caviglia sx sul ginocchio dx. Tira verso il petto.", "type": "timer", "duration": 45, "rest": 5, "reps": 1},
                            {"name": "Figure 4 Stretch - RIGHT", "description": "Cambia lato. Respira profondamente.", "type": "timer", "duration": 45, "rest": 5, "reps": 1},
                            {"name": "Child's Pose", "description": "Rilassati completamente. Respira. Ce l'hai fatta! üéâ", "type": "timer", "duration": 60, "rest": 0, "reps": 1}
                        ]
                    }
                };
            }
            currentWorkoutId = localStorage.getItem('currentWorkoutId') || 'default';
            if (!workouts[currentWorkoutId]) {
                currentWorkoutId = Object.keys(workouts)[0];
            }
        }
        
        function getCurrentWorkout() {
            return workouts[currentWorkoutId] || { name: 'Workout', exercises: [] };
        }
        
        // Render
        function renderWorkoutTabs() {
            const tabs = document.getElementById('workoutTabs');
            tabs.innerHTML = Object.entries(workouts).map(([id, w]) => `
                <button class="workout-tab ${id === currentWorkoutId ? 'active' : ''}" 
                        onclick="selectWorkout('${id}')">
                    ${w.name}
                    ${Object.keys(workouts).length > 1 ? `<span class="delete" onclick="event.stopPropagation(); deleteWorkout('${id}')">‚úï</span>` : ''}
                </button>
            `).join('');
        }
        
        function renderExercises() {
            const list = document.getElementById('exerciseList');
            const empty = document.getElementById('emptyState');
            const startBar = document.getElementById('startBar');
            const workout = getCurrentWorkout();
            
            if (workout.exercises.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                startBar.style.display = 'none';
                return;
            }
            
            empty.style.display = 'none';
            startBar.style.display = 'block';
            
            list.innerHTML = workout.exercises.map((ex, i) => `
                <div class="exercise-card" draggable="true" data-index="${i}">
                    <span class="drag-handle">‚ò∞</span>
                    <div class="info">
                        <div class="name">${ex.name}</div>
                        <div class="meta">
                            <span>${ex.type === 'timer' ? '‚è± ' + ex.duration + 's' : 'üî¢ ' + ex.reps + ' reps'}</span>
                            <span>üí§ ${ex.rest}s recupero</span>
                        </div>
                    </div>
                    <div class="actions">
                        <button onclick="editExercise(${i})">‚úèÔ∏è</button>
                        <button onclick="deleteExercise(${i})">üóë</button>
                    </div>
                </div>
            `).join('');
            
            // Drag & drop
            setupDragDrop();
        }
        
        function setupDragDrop() {
            const cards = document.querySelectorAll('.exercise-card');
            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });
        }
        
        let dragSrcIndex = null;
        
        function handleDragStart(e) {
            dragSrcIndex = parseInt(this.dataset.index);
            this.style.opacity = '0.4';
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            return false;
        }
        
        function handleDrop(e) {
            e.stopPropagation();
            const targetIndex = parseInt(this.dataset.index);
            if (dragSrcIndex !== targetIndex) {
                const workout = getCurrentWorkout();
                const [removed] = workout.exercises.splice(dragSrcIndex, 1);
                workout.exercises.splice(targetIndex, 0, removed);
                saveData();
                renderExercises();
            }
            return false;
        }
        
        function handleDragEnd(e) {
            this.style.opacity = '1';
        }
        
        // Modals
        function showAddExerciseModal() {
            document.getElementById('modalTitle').textContent = '‚ûï Aggiungi Esercizio';
            document.getElementById('editIndex').value = -1;
            document.getElementById('exerciseForm').reset();
            document.getElementById('exDuration').value = 30;
            document.getElementById('exReps').value = 10;
            document.getElementById('exRest').value = 15;
            toggleTypeFields();
            document.getElementById('exerciseModal').classList.add('active');
        }
        
        function editExercise(index) {
            const ex = getCurrentWorkout().exercises[index];
            document.getElementById('modalTitle').textContent = '‚úèÔ∏è Modifica Esercizio';
            document.getElementById('editIndex').value = index;
            document.getElementById('exName').value = ex.name;
            document.getElementById('exDesc').value = ex.description || '';
            document.getElementById('exType').value = ex.type;
            document.getElementById('exDuration').value = ex.duration || 30;
            document.getElementById('exReps').value = ex.reps || 10;
            document.getElementById('exRest').value = ex.rest || 15;
            toggleTypeFields();
            document.getElementById('exerciseModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }
        
        function toggleTypeFields() {
            const type = document.getElementById('exType').value;
            document.getElementById('timerGroup').style.display = type === 'timer' ? 'block' : 'none';
            document.getElementById('repsGroup').style.display = type === 'reps' ? 'block' : 'none';
        }
        
        function saveExercise(e) {
            e.preventDefault();
            const index = parseInt(document.getElementById('editIndex').value);
            const exercise = {
                name: document.getElementById('exName').value,
                description: document.getElementById('exDesc').value,
                type: document.getElementById('exType').value,
                duration: parseInt(document.getElementById('exDuration').value),
                reps: parseInt(document.getElementById('exReps').value),
                rest: parseInt(document.getElementById('exRest').value)
            };
            
            const workout = getCurrentWorkout();
            if (index === -1) {
                workout.exercises.push(exercise);
            } else {
                workout.exercises[index] = exercise;
            }
            
            saveData();
            renderExercises();
            closeModal();
        }
        
        function deleteExercise(index) {
            if (confirm('Eliminare questo esercizio?')) {
                getCurrentWorkout().exercises.splice(index, 1);
                saveData();
                renderExercises();
            }
        }
        
        // Workout Management
        function selectWorkout(id) {
            currentWorkoutId = id;
            saveData();
            renderWorkoutTabs();
            renderExercises();
        }
        
        function showNewWorkoutModal() {
            document.getElementById('newWorkoutName').value = '';
            document.getElementById('newWorkoutModal').classList.add('active');
        }
        
        function closeNewWorkoutModal() {
            document.getElementById('newWorkoutModal').classList.remove('active');
        }
        
        function createWorkout(e) {
            e.preventDefault();
            const name = document.getElementById('newWorkoutName').value;
            const id = 'workout_' + Date.now();
            workouts[id] = { name, exercises: [] };
            currentWorkoutId = id;
            saveData();
            renderWorkoutTabs();
            renderExercises();
            closeNewWorkoutModal();
        }
        
        function deleteWorkout(id) {
            if (Object.keys(workouts).length <= 1) {
                alert('Devi avere almeno un workout!');
                return;
            }
            if (confirm('Eliminare questo workout?')) {
                delete workouts[id];
                if (currentWorkoutId === id) {
                    currentWorkoutId = Object.keys(workouts)[0];
                }
                saveData();
                renderWorkoutTabs();
                renderExercises();
            }
        }
        
        function deleteCurrentWorkout() {
            const workout = getCurrentWorkout();
            if (Object.keys(workouts).length <= 1) {
                // If only one workout, just clear exercises
                if (confirm('Vuoi svuotare tutti gli esercizi?')) {
                    workouts[currentWorkoutId].exercises = [];
                    saveData();
                    renderExercises();
                    alert('Workout svuotato!');
                }
                return;
            }
            if (confirm(`Eliminare "${workout.name}"?`)) {
                delete workouts[currentWorkoutId];
                currentWorkoutId = Object.keys(workouts)[0];
                saveData();
                renderWorkoutTabs();
                renderExercises();
                alert('Workout eliminato!');
            }
        }
        
        // Import/Export
        function showImportModal() {
            document.getElementById('importCode').value = '';
            document.getElementById('importModal').classList.add('active');
        }
        
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }
        
        function importWorkout() {
            try {
                const code = document.getElementById('importCode').value.trim();
                // Try UTF-8 safe decode first, fallback to regular atob
                let jsonStr;
                try {
                    jsonStr = base64ToUtf8(code);
                } catch (e) {
                    jsonStr = atob(code);
                }
                const data = JSON.parse(jsonStr);
                if (data.name && data.exercises) {
                    const id = 'workout_' + Date.now();
                    workouts[id] = data;
                    currentWorkoutId = id;
                    saveData();
                    renderWorkoutTabs();
                    renderExercises();
                    closeImportModal();
                    alert('Workout importato! üéâ');
                } else {
                    throw new Error('Invalid format');
                }
            } catch (err) {
                alert('Codice non valido. Controlla e riprova.');
            }
        }
        
        // UTF-8 safe base64 encode/decode
        function utf8ToBase64(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                return String.fromCharCode('0x' + p1);
            }));
        }
        
        function base64ToUtf8(str) {
            return decodeURIComponent(atob(str).split('').map(c => {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }
        
        function showExportModal() {
            try {
                const workout = getCurrentWorkout();
                const code = utf8ToBase64(JSON.stringify(workout));
                document.getElementById('exportCode').value = code;
                document.getElementById('exportModal').classList.add('active');
            } catch (err) {
                alert('Errore export: ' + err.message);
            }
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }
        
        function copyExportCode() {
            const code = document.getElementById('exportCode');
            code.select();
            document.execCommand('copy');
            alert('Codice copiato! üìã');
        }
        
        // Exercise Animation Mapping
        function getExerciseAnimation(name) {
            const n = name.toLowerCase();
            
            // Rest/Recovery
            if (n.includes('recupero') || n.includes('rest') || n.includes('üí§')) {
                return { emoji: 'üòå', anim: 'anim-rest' };
            }
            
            // Stretching
            if (n.includes('stretch') || n.includes('child') || n.includes('butterfly') || n.includes('yoga')) {
                return { emoji: 'üßò', anim: 'anim-stretch' };
            }
            
            // Squat variations
            if (n.includes('squat') || n.includes('wall sit')) {
                if (n.includes('jump')) return { emoji: 'ü¶ò', anim: 'anim-bounce' };
                if (n.includes('wall')) return { emoji: 'üß±', anim: 'anim-wallsit' };
                return { emoji: 'üèãÔ∏è', anim: 'anim-squat' };
            }
            
            // Lunges
            if (n.includes('lunge') || n.includes('affond')) {
                return { emoji: 'ü¶µ', anim: 'anim-lunge' };
            }
            
            // Bridge
            if (n.includes('bridge') || n.includes('ponte')) {
                return { emoji: 'üåâ', anim: 'anim-bridge' };
            }
            
            // Curls (leg)
            if (n.includes('curl')) {
                return { emoji: 'ü¶ø', anim: 'anim-curl' };
            }
            
            // Calf raises
            if (n.includes('calf') || n.includes('relev')) {
                return { emoji: 'ü¶∂', anim: 'anim-calf' };
            }
            
            // Swimming
            if (n.includes('swim')) {
                return { emoji: 'üèä', anim: 'anim-swim' };
            }
            
            // Crunch / Abs
            if (n.includes('crunch') || n.includes('ab') || n.includes('bicicl')) {
                return { emoji: 'üí™', anim: 'anim-curl' };
            }
            
            // Round markers
            if (n.includes('round') || n.includes('üî•')) {
                return { emoji: 'üî•', anim: 'anim-bounce' };
            }
            
            // Default
            return { emoji: 'üí™', anim: 'anim-bounce' };
        }
        
        // Workout Execution
        function startWorkout() {
            const workout = getCurrentWorkout();
            if (workout.exercises.length === 0) return;
            
            currentExerciseIndex = 0;
            isResting = false;
            isPaused = false;
            workoutStartTime = Date.now();
            
            document.getElementById('listView').classList.remove('active');
            document.getElementById('workoutView').classList.add('active');
            
            requestWakeLock();
            audioCtx.resume();
            showCurrentExercise();
        }
        
        function exitWorkout() {
            if (confirm('Vuoi uscire dall\'allenamento?')) {
                stopTimer();
                releaseWakeLock();
                document.getElementById('workoutView').classList.remove('active');
                document.getElementById('listView').classList.add('active');
            }
        }
        
        function showCurrentExercise() {
            const workout = getCurrentWorkout();
            const ex = workout.exercises[currentExerciseIndex];
            
            const main = document.getElementById('workoutMain');
            main.className = 'workout-main fade-in' + (isResting ? ' rest-screen' : '');
            
            document.getElementById('progressText').textContent = 
                `${currentExerciseIndex + 1}/${workout.exercises.length}`;
            document.getElementById('progressFill').style.width = 
                `${((currentExerciseIndex + 1) / workout.exercises.length) * 100}%`;
            
            const animDiv = document.getElementById('exerciseAnimation');
            
            if (isResting) {
                document.getElementById('currentExerciseName').textContent = 'üí§ Recupero';
                document.getElementById('currentExerciseDesc').innerHTML = 
                    `<div class="next-up"><div class="label">Prossimo:</div><div class="name">${
                        currentExerciseIndex + 1 < workout.exercises.length 
                            ? workout.exercises[currentExerciseIndex + 1].name 
                            : 'üéâ Fine!'
                    }</div></div>`;
                animDiv.textContent = 'üòå';
                animDiv.className = 'exercise-animation anim-rest';
                startTimer(ex.rest);
            } else {
                const anim = getExerciseAnimation(ex.name);
                animDiv.textContent = anim.emoji;
                animDiv.className = 'exercise-animation ' + anim.anim;
                document.getElementById('currentExerciseName').textContent = ex.name;
                document.getElementById('currentExerciseDesc').textContent = ex.description || '';
                
                if (ex.type === 'timer') {
                    startTimer(ex.duration);
                } else {
                    // Reps mode - show reps, manual advance
                    document.getElementById('timerDisplay').innerHTML = 
                        `<div class="reps-display">${ex.reps} <span>reps</span></div>`;
                    document.getElementById('playPauseBtn').textContent = '‚úì';
                }
            }
            
            playBeep(600, 100);
        }
        
        function startTimer(seconds) {
            stopTimer();
            remainingTime = seconds;
            updateTimerDisplay();
            document.getElementById('playPauseBtn').textContent = '‚è∏';
            
            timerInterval = setInterval(() => {
                if (!isPaused) {
                    remainingTime--;
                    updateTimerDisplay();
                    
                    // Countdown beeps for last 5 seconds
                    if (remainingTime <= 5 && remainingTime > 0) {
                        if (remainingTime <= 3) {
                            // Last 3 seconds: higher pitch, louder
                            playBeep(800, 150);
                        } else {
                            // 5 and 4 seconds: lower pitch
                            playBeep(500, 100);
                        }
                    }
                    
                    if (remainingTime <= 0) {
                        stopTimer();
                        playComplete();
                        
                        // Vibrate if available
                        if ('vibrate' in navigator) {
                            navigator.vibrate([200, 100, 200]);
                        }
                        
                        advanceExercise();
                    }
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function updateTimerDisplay() {
            const mins = Math.floor(remainingTime / 60);
            const secs = remainingTime % 60;
            document.getElementById('timerDisplay').textContent = 
                `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function togglePause() {
            const workout = getCurrentWorkout();
            const ex = workout.exercises[currentExerciseIndex];
            
            if (ex.type === 'reps' && !isResting) {
                // Manual complete for reps
                advanceExercise();
                return;
            }
            
            isPaused = !isPaused;
            document.getElementById('playPauseBtn').textContent = isPaused ? '‚ñ∂' : '‚è∏';
            
            if (isPaused) {
                document.getElementById('playPauseBtn').classList.add('pulse');
            } else {
                document.getElementById('playPauseBtn').classList.remove('pulse');
            }
        }
        
        function advanceExercise() {
            const workout = getCurrentWorkout();
            
            if (isResting) {
                // Move to next exercise
                currentExerciseIndex++;
                isResting = false;
                
                if (currentExerciseIndex >= workout.exercises.length) {
                    completeWorkout();
                    return;
                }
            } else {
                // Start rest period
                const ex = workout.exercises[currentExerciseIndex];
                if (ex.rest > 0) {
                    isResting = true;
                } else {
                    // No rest, go to next
                    currentExerciseIndex++;
                    if (currentExerciseIndex >= workout.exercises.length) {
                        completeWorkout();
                        return;
                    }
                }
            }
            
            showCurrentExercise();
        }
        
        function nextExercise() {
            stopTimer();
            isResting = false;
            currentExerciseIndex++;
            
            const workout = getCurrentWorkout();
            if (currentExerciseIndex >= workout.exercises.length) {
                completeWorkout();
                return;
            }
            
            showCurrentExercise();
        }
        
        function prevExercise() {
            stopTimer();
            isResting = false;
            if (currentExerciseIndex > 0) {
                currentExerciseIndex--;
            }
            showCurrentExercise();
        }
        
        function completeWorkout() {
            stopTimer();
            releaseWakeLock();
            
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            
            document.getElementById('statExercises').textContent = getCurrentWorkout().exercises.length;
            document.getElementById('statTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            document.getElementById('workoutView').classList.remove('active');
            document.getElementById('listView').classList.add('active');
            document.getElementById('completeModal').classList.add('active');
            
            playComplete();
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 400]);
            }
        }
        
        function closeCompleteModal() {
            document.getElementById('completeModal').classList.remove('active');
        }
        
        // Check for workout code in URL
        function checkUrlImport() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('w');
            if (code) {
                try {
                    // Try UTF-8 safe decode first, fallback to regular atob
                    let jsonStr;
                    try {
                        jsonStr = base64ToUtf8(code);
                    } catch (e) {
                        jsonStr = atob(code);
                    }
                    const data = JSON.parse(jsonStr);
                    if (data.name && data.exercises) {
                        const id = 'workout_' + Date.now();
                        workouts[id] = data;
                        currentWorkoutId = id;
                        // Save multiple times to ensure persistence
                        saveData();
                        localStorage.setItem('patrickWorkouts', JSON.stringify(workouts));
                        localStorage.setItem('currentWorkoutId', currentWorkoutId);
                        // Clean URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        alert(`Workout "${data.name}" importato e salvato! üéâ\n\n${data.exercises.length} esercizi caricati.`);
                    }
                } catch (err) {
                    console.log('Invalid URL workout code:', err);
                    alert('Codice workout non valido!');
                }
            }
        }
        
        // Debug function to check storage
        function checkStorage() {
            const saved = localStorage.getItem('patrickWorkouts');
            console.log('Stored workouts:', saved);
            alert('Workout salvati: ' + Object.keys(workouts).length + '\nWorkout corrente: ' + getCurrentWorkout().name);
        }
        
        // Init
        loadData();
        checkUrlImport();
        renderWorkoutTabs();
        renderExercises();
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
        }
    </script>
</body>
</html>
